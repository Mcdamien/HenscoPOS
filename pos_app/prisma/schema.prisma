generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model MainAccount {
  id          String            @id @default(cuid())
  code        String            @unique
  name        String            @unique
  type        AccountType
  description String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  categories  AccountCategory[]
  accounts    Account[]

  @@map("main_accounts")
}

model AccountCategory {
  id            String      @id @default(cuid())
  mainAccountId String
  name          String
  description   String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  mainAccount   MainAccount @relation(fields: [mainAccountId], references: [id], onDelete: Cascade)
  accounts      Account[]

  @@map("account_categories")
}

model Account {
  id             String             @id @default(cuid())
  code           String             @unique
  name           String
  type           AccountType
  subType        AccountSubType?
  categoryId     String?
  mainAccountId  String?
  balance        Float              @default(0)
  currency       String             @default("GHS")
  isActive       Boolean            @default(true)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  mainAccount    MainAccount?       @relation(fields: [mainAccountId], references: [id])
  category       AccountCategory?   @relation(fields: [categoryId], references: [id])
  journalEntries JournalEntryLine[]

  confirmedAt    DateTime?
  confirmedBy    String?

  @@map("accounts")
}

model JournalEntry {
  id          String             @id @default(cuid())
  entryNumber String             @unique
  date        DateTime
  description String
  reference   String?
  isPosted    Boolean            @default(false)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  lines       JournalEntryLine[]

  @@map("journal_entries")
}

model JournalEntryLine {
  id             String       @id @default(cuid())
  journalEntryId String
  accountId      String
  description    String
  debit          Float        @default(0)
  credit         Float        @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  account        Account      @relation(fields: [accountId], references: [id])
  journalEntry   JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)

  @@map("journal_entry_lines")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Store {
  id             String                   @id @default(cuid())
  name           String                   @unique
  location       String?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  inventories    Inventory[]
  pendingChanges PendingInventoryChange[]
  transactions   Transaction[]
}

model Product {
  id                     String                   @id @default(cuid())
  itemId                 Int                      @unique
  name                   String
  cost                   Float
  price                  Float
  warehouseStock         Int                      @default(0)
  restockQty             Int                      @default(0)
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  inventories            Inventory[]
  pendingChanges         PendingInventoryChange[]
  transactionItems       TransactionItem[]
  inventoryAdditionItems InventoryAdditionItem[]
  stockTransferItems     StockTransferItem[]
}

model Inventory {
  id        String   @id @default(cuid())
  storeId   String
  productId String
  stock     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([storeId, productId])
}

model PendingInventoryChange {
  id          String    @id @default(cuid())
  productId   String
  storeId     String
  changeType  String    @default("add")
  qty         Int       @default(0)
  newCost     Float?
  newPrice    Float?
  reason      String?
  status      String    @default("pending")
  requestedBy String?
  reviewedBy  String?
  reviewedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  store       Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([storeId])
  @@index([productId])
}

model Transaction {
  id            String            @id @default(cuid())
  transactionId Int               @unique
  storeId       String
  subtotal      Float
  tax           Float
  total         Float
  createdAt     DateTime          @default(now())
  store         Store             @relation(fields: [storeId], references: [id])
  items         TransactionItem[]

  @@index([createdAt])
}

model TransactionItem {
  id            String      @id @default(cuid())
  transactionId String
  productId     String
  itemName      String
  itemPrice     Float
  itemCost      Float
  qty           Int
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  product       Product     @relation(fields: [productId], references: [id])
}

model StockTransfer {
  id              String              @id @default(cuid())
  transferId      Int                 @unique
  fromStore       String?
  toStore         String
  status          String              @default("pending")
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  confirmedAt     DateTime?
  confirmedBy     String?
  cancelledAt     DateTime?
  cancelledReason String?
  items           StockTransferItem[]

  @@index([createdAt])
  @@index([status])
  @@index([toStore])
  @@map("stock_transfers")
}

model StockTransferItem {
  id              String        @id @default(cuid())
  stockTransferId String
  productId       String
  itemName        String
  qty             Int
  stockTransfer   StockTransfer @relation(fields: [stockTransferId], references: [id], onDelete: Cascade)
  product         Product       @relation(fields: [productId], references: [id])

  @@map("stock_transfer_items")
}

model InventoryAddition {
  id          String                  @id @default(cuid())
  additionId  Int                     @unique
  referenceId String?
  totalCost   Float
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  items       InventoryAdditionItem[]

  @@index([createdAt])
  @@map("inventory_additions")
}

model InventoryAdditionItem {
  id                  String            @id @default(cuid())
  inventoryAdditionId String
  productId           String
  itemName            String
  cost                Float
  price               Float
  qty                 Int
  inventoryAddition   InventoryAddition @relation(fields: [inventoryAdditionId], references: [id], onDelete: Cascade)
  product             Product           @relation(fields: [productId], references: [id])

  @@map("inventory_addition_items")
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum AccountSubType {
  CURRENT_ASSET
  FIXED_ASSET
  CURRENT_LIABILITY
  LONG_TERM_LIABILITY
  OPERATING_EXPENSE
  COGS
  OTHER
}
